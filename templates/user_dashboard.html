<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>User Dashboard - Online Lucky Draw System</title>
    {% load static %}
    <link rel="stylesheet" href="{% static 'accounts/css/user.css' %}">
    <link rel="stylesheet" href="{% static 'accounts/css/user_dashboard.css' %}">
    <link rel="stylesheet" href="{% static 'accounts/css/user_dashboard_clean.css' %}">
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&family=Montserrat:wght@800;900&display=swap" rel="stylesheet">
</head>
<body class="dashboard-body">
    <nav class="navbar navbar-expand-lg navbar-dark dashboard-nav">
        <div class="container">
            <a class="navbar-brand glow-text" href="{% url 'user_dashboard' %}">
                <i class="fas fa-dice me-2"></i>
                Lucky<span class="brand-highlight">Draw</span>
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto">
                    <li class="nav-item"><a class="nav-link active" href="{% url 'user_dashboard' %}">Dashboard</a></li>
                    <li class="nav-item"><a class="nav-link" href="{% url 'all_draws' %}">Draws</a></li>
                    <li class="nav-item"><a class="nav-link" href="{% url 'my_wins' %}">My Wins</a></li>
                    <li class="nav-item"><a class="nav-link" href="{% url 'home' %}">How It Works</a></li>
                </ul>
                <div class="user-profile">
                    <span class="user-welcome">Welcome, <strong>{{ user.username }}</strong></span>
                    <div class="user-coin-balance" aria-live="polite">
                        <i class="fas fa-coins"></i>
                        <span>{{ user_entry_count|default:0 }} Credits</span>
                    </div>
                </div>
            </div>
        </div>
    </nav>

    <div class="user-dashboard container-fluid">
        <div class="dashboard-header">
            <h1 class="dashboard-title">Your Lucky Dashboard</h1>
            <p class="dashboard-subtitle">Track your participations, wins, and available draws</p>
            <div class="stats-container">
                <div class="stat-card">
                    <div class="stat-icon"><i class="fas fa-ticket-alt"></i></div>
                    <div class="stat-content">
                        <h3>{% if joined_draws %}{{ joined_draws|length }}{% else %}0{% endif %}</h3>
                        <p>Participations</p>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon"><i class="fas fa-trophy"></i></div>
                    <div class="stat-content">
                        <h3>{{ user_wins|length|default:0 }}</h3>
                        <p>Wins</p>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon"><i class="fas fa-gem"></i></div>
                    <div class="stat-content">
                        <h3>{{ available_draws|length }}</h3>
                        <p>Available Draws</p>
                    </div>
                </div>
            </div>
        </div>

        <div class="row g-4">
            <div class="col-lg-8">
                {% if messages %}
                <div class="mb-3">
                    {% for msg in messages %}
                    <div class="alert alert-{{ msg.tags }} mb-2">{{ msg }}</div>
                    {% endfor %}
                </div>
                {% endif %}

                <div class="dashboard-card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <div>
                            <h2 class="card-title">My Participations</h2>
                            <p class="card-subtitle">Track your entries and results</p>
                        </div>
                        <div class="d-flex align-items-center gap-2">
                            <button class="btn btn-sm btn-outline-secondary" type="button" data-bs-toggle="collapse" data-bs-target="#participationsSection" aria-expanded="true" aria-controls="participationsSection">
                                <i class="fas fa-chevron-down"></i>
                            </button>
                            <a href="{% url 'all_draws' %}" class="btn btn-gradient">Browse Draws</a>
                        </div>
                    </div>
                    <div id="participationsSection" class="collapse show">
                        <div class="card-body">
                        {% if joined_draws %}
                        <div class="table-responsive">
                            <table class="table table-hover participation-table">
                                <thead>
                                    <tr>
                                        <th class="ps-4">Draw</th>
                                        <th>Status</th>
                                        <th class="text-end pe-4">Action</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for draw in joined_draws %}
                                    <tr class="table-row-animated">
                                        <td>
                                            <div class="draw-info">
                                                <div class="draw-title">{{ draw.title }}</div>
                                                <div class="draw-prize"><i class="fas fa-gift me-1"></i>{{ draw.prize_name }}</div>
                                            </div>
                                        </td>
                                        <td>
                                            {% if draw.user_won %}
                                            <div class="status-badge winner">Winner (#{% if draw.user_win_position %}{{ draw.user_win_position }}{% else %}1{% endif %})</div>
                                            {% elif draw.winners_selected %}
                                            <div class="status-badge closed">Closed</div>
                                            {% else %}
                                            <div class="status-badge open">Open</div>
                                            {% endif %}
                                        </td>
                                        <td class="text-end"><a href="{% url 'draw_detail' draw.id %}" class="btn btn-sm btn-view">View</a></td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                        {% else %}
                        <div class="empty-state">
                            <div class="empty-icon"><i class="fas fa-ticket-alt"></i></div>
                            <h4>No Participations Yet</h4>
                            <p>Join your first lucky draw to start winning!</p>
                            <a href="{% url 'all_draws' %}" class="btn btn-primary mt-3">Explore Draws</a>
                        </div>
                        {% endif %}
                    </div>
                    </div>
                </div>

                <div class="dashboard-card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <div>
                            <h2 class="card-title">Draw History</h2>
                            <p class="card-subtitle">Your most recent entries and outcomes</p>
                        </div>
                        <div class="d-flex align-items-center gap-2">
                            <button class="btn btn-sm btn-outline-secondary" type="button" data-bs-toggle="collapse" data-bs-target="#drawHistorySection" aria-expanded="true" aria-controls="drawHistorySection">
                                <i class="fas fa-chevron-down"></i>
                            </button>
                            <a href="{% url 'all_draws' %}" class="btn btn-hero btn-sm">Explore</a>
                        </div>
                    </div>
                    <div id="drawHistorySection" class="collapse show">
                        <div class="card-body">
                        {% if draw_history %}
                        <div class="draw-history-list">
                            {% for item in draw_history %}
                            <div class="draw-history-item">
                                <div>
                                    <div class="history-title">{{ item.draw.title }}</div>
                                    <div class="history-meta">
                                        Joined {{ item.entry.entry_time|date:"M d, Y" }} • Prize: {{ item.draw.prize_name }}
                                    </div>
                                </div>
                                <div class="history-status {{ item.status_class }}">
                                    {{ item.status }}{% if item.position %} #{{ item.position }}{% endif %}
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                        {% else %}
                        <div class="empty-state">
                            <div class="empty-icon"><i class="fas fa-history"></i></div>
                            <h4>No Draw History Yet</h4>
                            <p>Join a draw to start building your history.</p>
                        </div>
                        {% endif %}
                        </div>
                    </div>
                </div>

                <div class="dashboard-card">
                    <div class="card-header">
                        <h2 class="card-title">Available Lucky Draws</h2>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            {% for draw in available_draws %}
                            <div class="col-md-6 mb-4">
                                <div class="draw-card">
                                    <div class="draw-card-header d-flex justify-content-between align-items-center">
                                        <span class="open-badge">Open</span>
                                        <small class="text-muted"><i class="far fa-clock me-1"></i>Instant</small>
                                    </div>
                                    <div class="draw-card-body">
                                        <div class="draw-title">{{ draw.title }}</div>
                                        <div class="draw-description">Prize: {{ draw.prize_name }}</div>
                                        <div class="draw-prize-info mt-2">
                                            <div class="d-flex align-items-center gap-2">
                                                <div class="prize-icon"><i class="fas fa-gift"></i></div>
                                                <div class="prize-details">
                                                    <strong>{{ draw.prize_name }}</strong>
                                                    {% if draw.prize_value %}
                                                    <span class="prize-value">{{ draw.prize_value }}</span>
                                                    {% endif %}
                                                </div>
                                            </div>
                                        </div>
                                        <div class="draw-stats mt-2">
                                            <div class="stat"><i class="fas fa-trophy"></i><span>{{ draw.winners_count }} winner{% if draw.winners_count|default:0 > 1 %}s{% endif %}</span></div>
                                            <div class="stat"><i class="fas fa-users"></i><span>{{ draw.entries.count }} participants</span></div>
                                        </div>
                                        {% if draw.user_entry and draw.user_entry.is_verified %}
                                        <div class="verification-badge verified mt-2"><i class="fas fa-check-circle"></i> Verified</div>
                                        {% elif draw.user_entry and not draw.user_entry.is_verified %}
                                        <div class="verification-badge pending mt-2"><i class="fas fa-clock"></i> Pending</div>
                                        {% endif %}
                                        {% if draw.winners_selected %}
                                        <button class="btn btn-draw-closed w-100 mt-3" disabled>Draw Closed</button>
                                        {% elif draw.already_joined %}
                                        <button class="btn btn-draw-joined w-100 mt-3" disabled>Already Participated</button>
                                        {% else %}
                                        <form method="post" action="{% url 'join_draw' draw.id %}" class="mt-3">
                                            {% csrf_token %}
                                            <button class="btn btn-draw-participate w-100" type="submit">Participate Now</button>
                                        </form>
                                        {% endif %}
                                    </div>
                                    <div class="draw-card-footer">
                                        <div class="draw-chance">
                                            <div class="chance-meter"><div class="chance-fill" style="width: {% widthratio draw.entries.count 100 50 %}%"></div></div>
                                            <span>Win Chance</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            {% empty %}
                            <div class="col-12">
                                <div class="no-draws">
                                    <i class="fas fa-search"></i>
                                    <h4>No Available Draws</h4>
                                    <p>Check back later for new lucky draw opportunities!</p>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>

                <div class="dashboard-card">
                    <div class="card-header">
                        <h2 class="card-title">Fairness & Transparency</h2>
                    </div>
                    <div class="card-body">
                        <div class="fairness-grid">
                            <div class="fairness-item">
                                <div class="fairness-icon"><i class="fas fa-random"></i></div>
                                <h5>Randomized Selection</h5>
                                <p>Secure randomized algorithm with optional seed for audit</p>
                            </div>
                            <div class="fairness-item">
                                <div class="fairness-icon"><i class="fas fa-eye"></i></div>
                                <h5>Transparent Results</h5>
                                <p>Results are published after winners are confirmed</p>
                            </div>
                            <div class="fairness-item">
                                <div class="fairness-icon"><i class="fas fa-check-double"></i></div>
                                <h5>Validated Entries</h5>
                                <p>Your entries are validated before selection</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-lg-4">
                <div class="dashboard-card quick-actions-card">
                    <div class="card-header">
                        <div>
                            <h2 class="card-title">Quick Actions</h2>
                            <p class="card-subtitle">Jump into the moments that matter</p>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="quick-actions-grid">
                            <a href="{% url 'all_draws' %}" class="quick-action-card" aria-label="Browse draws">
                                <div class="quick-action-icon primary"><i class="fas fa-ticket-alt"></i></div>
                                <div>
                                    <p class="quick-action-title">Browse Draws</p>
                                    <p class="quick-action-desc">See the latest live draws and lock in your entries.</p>
                                </div>
                            </a>
                            <a href="{% url 'my_wins' %}" class="quick-action-card" aria-label="View my wins">
                                <div class="quick-action-icon success"><i class="fas fa-trophy"></i></div>
                                <div>
                                    <p class="quick-action-title">My Wins</p>
                                    <p class="quick-action-desc">Review your winning streak and claim prizes.</p>
                                </div>
                            </a>
                            <a href="{% url 'profile' %}" class="quick-action-card" aria-label="Edit profile">
                                <div class="quick-action-icon primary"><i class="fas fa-user"></i></div>
                                <div>
                                    <p class="quick-action-title">Edit Profile</p>
                                    <p class="quick-action-desc">Update your contact details and preferences.</p>
                                </div>
                            </a>
                            <a href="{% url 'logout' %}" class="quick-action-card logout-card" aria-label="Sign out">
                                <div class="quick-action-icon danger"><i class="fas fa-sign-out-alt"></i></div>
                                <div>
                                    <p class="quick-action-title">Sign Out</p>
                                    <p class="quick-action-desc">Securely log out when you’re done for the day.</p>
                                </div>
                            </a>
                        </div>
                    </div>
                </div>

                <div class="dashboard-card notifications-card mt-4">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <div class="d-flex align-items-center gap-3">
                            <h2 class="card-title mb-0">Notifications</h2>
                        </div>
                        <div class="d-flex align-items-center gap-2">
                            <button class="btn btn-sm btn-outline-secondary" type="button" data-bs-toggle="collapse" data-bs-target="#notificationsSection" aria-expanded="true" aria-controls="notificationsSection">
                                <i class="fas fa-chevron-down"></i>
                            </button>
                            <span class="badge notification-count">{% if notifications %}{{ notifications|length }}{% else %}0{% endif %}</span>
                        </div>
                    </div>
                    <div id="notificationsSection" class="collapse show">
                        <div class="card-body">
                        {% if notifications %}
                        <div class="notifications-list" aria-live="polite">
                            {% for note in notifications %}
                            <div class="notification-item {{ note.type }}">
                                <p class="notification-title">{{ note.title }}</p>
                                <p class="notification-detail">{{ note.detail }}</p>
                                <small class="text-muted">{{ note.time|date:"M d, H:i" }}</small>
                            </div>
                            {% endfor %}
                        </div>
                        {% else %}
                        <div class="no-notifications">
                            <h5>No New Notifications</h5>
                            <p class="text-muted">You're all caught up!</p>
                        </div>
                        {% endif %}
                        <div class="notification-footer mt-2">
                            <i class="fas fa-info-circle me-1"></i>
                            Winners are notified by email once results are published
                        </div>
                        </div>
                    </div>
                </div>

                <div class="dashboard-card mt-4">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <div>
                            <h2 class="card-title">Recent Winners</h2>
                            <p class="card-subtitle">Latest 20</p>
                        </div>
                        <button class="btn btn-sm btn-outline-secondary" type="button" data-bs-toggle="collapse" data-bs-target="#recentWinnersSection" aria-expanded="true" aria-controls="recentWinnersSection">
                            <i class="fas fa-chevron-down"></i>
                        </button>
                    </div>
                    <div id="recentWinnersSection" class="collapse show">
                        <div class="card-body">
                        <div class="winner-tabs">
                            <div class="tab-header" role="tablist">
                                <button class="tab-btn active" data-tab="all" role="tab" aria-selected="true" aria-controls="all-winners">All Winners</button>
                                <button class="tab-btn" data-tab="my" role="tab" aria-selected="false" aria-controls="my-wins">My Wins</button>
                            </div>
                            <div class="tab-content">
                                <div class="tab-pane active" id="all-winners" role="tabpanel">
                                    {% if recent_winners %}
                                    <div class="winners-list">
                                        {% for w in recent_winners %}
                                        <div class="winner-item">
                                            <div class="winner-name">{{ w.user.username }}</div>
                                            <div class="winner-draw">{{ w.draw.title|truncatechars:20 }}</div>
                                            <div class="position-badge">#{{ w.position }}</div>
                                        </div>
                                        {% endfor %}
                                    </div>
                                    {% else %}
                                    <div class="no-winners">No winners announced yet</div>
                                    {% endif %}
                                </div>
                                <div class="tab-pane" id="my-wins" role="tabpanel">
                                    {% if user_recent_wins %}
                                    <div class="winners-list">
                                        {% for w in user_recent_wins %}
                                        <div class="winner-item">
                                            <div class="winner-name">{{ w.draw.title }}</div>
                                            <div class="winner-draw">Position #{{ w.position }}</div>
                                            <div class="winner-date">{{ w.selected_at|date:"M d" }}</div>
                                            <div class="winner-status">{{ w.claim_status }}</div>
                                        </div>
                                        {% endfor %}
                                    </div>
                                    {% else %}
                                    <div class="no-winners">No wins yet. Keep trying!</div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        <div class="live-indicator mt-2" role="status">Live Updates • {{ now|date:"M d, H:i" }}</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <footer class="dashboard-footer">
        <div class="container text-center">
            © 2024 Lucky Draw System. Fair gaming for everyone.
        </div>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>